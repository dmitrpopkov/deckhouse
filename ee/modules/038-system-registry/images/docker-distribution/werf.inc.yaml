{{- $REPO := "https://github.com/distribution/distribution"}}
{{- $BRANCH := "v2.8.3"}}
{{- $GIT_CLONE_DEST_PATH := "/go/src/github.com/docker/distribution"}}
---
artifact: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
from: {{ $.Images.BASE_GOLANG_22_ALPINE }}
mount:
  - fromPath: ~/go-pkg-cache
    to: /go/pkg
git:
  - add: /{{ $.ModulePath }}modules/038-{{ $.ModuleName }}/images/{{ $.ImageName }}/scripts
    to: /scripts
    stageDependencies:
      install:
        - '**/*'
  - add: /{{ $.ModulePath }}modules/038-{{ $.ModuleName }}/images/{{ $.ImageName }}/s3_healthcheck
    to: /s3_healthcheck
    stageDependencies:
      install:
        - '**/*'
  - add: /{{ $.ModulePath }}modules/038-{{ $.ModuleName }}/images/{{ $.ImageName }}/patches
    to: /patches
    stageDependencies:
      install:
      - '**/*'

shell:
  beforeInstall:
  - mkdir -m 1777 /tmp-tmp
  - apk add --no-cache git make bash gnupg
  install:
    - git config --global advice.detachedHead false
    - git clone --depth 1 --single-branch --branch {{ $BRANCH }} {{ $REPO }} {{ $GIT_CLONE_DEST_PATH }}
    - cd {{ $GIT_CLONE_DEST_PATH }}
    - git apply /patches/*.patch --verbose
    - export GOPROXY={{ .GOPROXY }}
    - export GOOS=linux
    - export GOARCH=amd64
    - export CGO_ENABLED=0
    - GO111MODULE=on script/setup/install-dev-tools
    - GO111MODULE=off make build
    - GO111MODULE=off make binaries
    - cd /s3_healthcheck
    - go build -ldflags="-s -w" -o /entrypoint ./main.go

---
image: "{{ $.ModuleName }}/{{ $.ImageName }}"
fromImage: common/distroless
import:
  - artifact: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: /tmp-tmp
    to: /tmp
    before: setup
  - artifact: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: "{{ $GIT_CLONE_DEST_PATH }}/bin/registry"
    to: /registry
    before: setup
  - artifact: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: /entrypoint
    to: /entrypoint
    before: setup
  - artifact: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: /scripts
    to: /
    before: setup
  - image: common/pause
    add: /pause
    to: /pause
    before: setup

docker:
  ENTRYPOINT: ["/entrypoint"]

